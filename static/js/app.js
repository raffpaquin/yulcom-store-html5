// Generated by CoffeeScript 1.6.3
(function(){var e,t,n,r,i,s,o,u,a,f,l;window.app={debug:!1,collections:{},models:{},views:{},config:{}};f=window.app;e=window.$;l=window._;n=window.Backbone;o=window.Modernizr;i=window.Handlebars;l.extend(f,n.Events);f.init=function(){return this};f.get=function(e){return this.config[e]};f.config=window.configs;u=n.View.extend({el:e("#content"),ressources:{template:null,collection:[],model:[]},queue:{template:0,collection:0,model:0},data:{},reset:function(){this.data={};this.ressources={template:null,collection:{},model:{}};return{queue:{template:0,collection:0,model:0}}},loadCollection:function(e,t){this.ressources.collection[e]=t;this.queue.collection++;return this.ressources.collection[e].fetch({success:function(){var n;n=f.views.page;n.data[e]=t.toJSON();n.queue.collection--;return n.render()}})},loadModel:function(e,t){t.bind("sync",function(){var n;n=f.views.page;n.data[e]=t.toJSON();n.queue.model--;return n.render()});this.ressources.model[e]=t;this.queue.model++;return this.ressources.model[e].fetch()},loadTemplate:function(e){this.ressources.template=e;this.queue.template++;return f.template.loadTemplateHtml(e,function(e){var t;t=f.views.page;t.queue.template--;return t.render()})},load:function(t){e("body").addClass("loading");if(t.menu){e("ul.menu li").removeClass("active");e("ul.menu li[data-href="+t.menu+"]").addClass("active")}return this.render()},render:function(){var t;t=(new Date).getTime();alert(t+" - "+this.queue.template);alert(t+" - "+this.queue.model);alert(t+" - "+this.queue.collection);if(this.queue.template===0&&this.queue.model===0&&this.queue.collection===0){console.log(this.data);this.$el.html(f.template.render(this.ressources.template,this.data));e("body").removeClass("loading");return e("body").scrollTop(0)}}});a=u.extend({loadProductCollection:function(){return f.collections.products.fetch()}});f.template={engines:[],requested:[],callback:{},render:function(e,t){return this.engines[e]?this.engines[e](t):alert("Unknow Template Engine")},block:function(t,n){var r,i;i=this.render(t);r=e(n);r.html(i);return!0},loadTemplateHtml:function(t,n){if(!this.engines[t]){if(!this.requested[t]){this.requested[t]=!0;this.callback[t]=[n];return e.ajax({url:"/static/template/"+t+".mustache",context:{engines:this.engines,template_id:t,callback:this.callback},success:function(e){var t,r,s,o;this.engines[this.template_id]=i.compile(e);s=this.callback[this.template_id];o=[];for(t=0,r=s.length;t<r;t++){n=s[t];o.push(n())}return o},cache:!0,dataType:"html"})}return this.callback[t].push(n)}return n()}};i.registerHelper("round",function(e){return Math.round(e)});i.registerHelper("money",function(e){var t;e=parseFloat(e);if(e>=0)return"$"+e.toFixed(2);t=-1*e;return"$"+t.toFixed(2)+""});i.registerHelper("time",function(e){return window.moment(e*1e3).from()});e(function(){return e("body").on("click","[data-action]",function(t){var n,r,i,s;n=e(this);i=n.attr("data-action").split("|");r=i[0];s=i[1]!=null?i[1]:"body";if(!r||r==="")return!1;f.views.menu.nav.destroy();f.trigger(r,{scope:s,cta:this});t.preventDefault();return!1})});e(function(){f.on("all",f.analytics.trackEvent);return f.controller.on("all",f.analytics.trackPageView)});f.analytics={trackEvent:function(e){},trackPageView:function(e){}};f.api={defaults:{url:"http://local.api.yulcom.ca/v1.0/terminal/"},post:function(t){t.data&&typeof t.data=="string"&&(t.data=this.stringToJson(t.data));t.url=this.defaults.url+t.url;t.dataType="json";t.beforeSend=function(t){e("#progress").stop();e("#progress").animate({width:"0%"},0);if(f.models.customer.credentials[0]&&f.models.customer.credentials[1])return t.setRequestHeader("Authorization","Basic "+window.btoa(f.models.customer.credentials.join(":")))};t.xhr=function(){var t;t=e.ajaxSettings.xhr();if(t instanceof window.XMLHttpRequest){t.upload&&t.upload.addEventListener("progress",function(t){var n;if(t.lengthComputable){n=t.loaded/t.total*100;return e("#progress").animate({width:percentage+"%"},200)}},!1);t.addEventListener("progress",function(e){var t;if(e.lengthComputable)return t=e.loaded/e.total*100},!1)}return t};t.complete=function(){e("#progress").stop();return e("#progress").animate({width:"100%"},300)};e.ajax(t);return!0},stringToJson:function(e){return JSON.parse('{"'+decodeURIComponent(e).replace(/"/g,'\\"').replace(/&/g,'","').replace(/\=/g,'":"')+'"}')}};f.cookies={read:function(e){var t,n;e==null&&(e="");t=new RegExp("(?:^|; )"+encodeURIComponent(e)+"=([^;]*)");n=t.exec(document.cookie);return n!=null?n[1]:!1},write:function(e,t,n){var r,i;t==null&&(t="");n==null&&(n=360);i=new Date;i.setDate(i.getDate()+n);r=escape(t);n!=null&&(r=r+"; expires="+i.toUTCString());document.cookie=e+"="+r;return!0},"delete":function(e){return document.cookie=encodeURIComponent(e)+"=deleted; expires="+(new Date(0)).toUTCString()}};f.validator={validateSizes:function(t){var n,r;r=e(".btn-size a",t.scope);if(r.length>0){n=e(".btn-size a.active",t.scope);if(n.length<=0){e(".alert",t.scope).first().text("Please select a size").show(0);return!1}e(".alert",t.scope).first().text("").hide(0)}return!0}};s=n.Model.extend();f.checkout={current_page:null,order:{"shipping-address":1,"billing-address":2,"payment-method":3,review:4},init:function(){this.current_page=null;return this.goTo("shipping-address")},goTo:function(t){var n;if(t===this.current_page)return;if(this.order[t]==null)return;if(e(".checkout-panel li.step-"+t).length===0){setTimeout(function(){return f.checkout.goTo(t)},200);return}this.order[t]>this.order[this.current_page]?n=-1:n=1;e(".checkout-panel").animate({opacity:0,left:200*n+"px"},200,"swing",function(){e(".checkout-panel li").hide(0);e(".checkout-progress li").removeClass("active");e(".checkout-progress li.progress-"+t).addClass("active");e(".checkout-panel li.step-"+t).show(0);e(".checkout-panel").css({left:-200*n+"px"});return e(".checkout-panel").animate({opacity:1,left:0},200,"swing",function(){e(".checkout-panel li.step-"+t+" input").first().focus();if(t==="payment-method")return e("input.cc-num").payment("formatCardNumber")})});this.current_page=t;return!0},saveSection:function(e){switch(e){case"shipping-address":return this.goTo("billing-address");case"billing-address":return this.goTo("payment-method");case"payment-method":return this.goTo("review");case"review":return alert("ORDER BITCHES!")}},toggleForm:function(t){var n,r;n=e("form",".step-"+t);r=e(".form-list",".step-"+t);return n.is(":visible")?n.fadeOut(100,function(){return r.fadeIn(100)}):r.fadeOut(100,function(){return n.fadeIn(100)})}};f.models.product=n.Model.extend({url:function(){return f.get("api")+"catalog/product/"+this.id+"/details"},parse:function(e){return e.data?e.data:e}});r=n.Collection.extend({model:f.models.product,url:f.get("api")+"catalog/product/list",parse:function(e){return l.map(e.data.items,function(e){e.id=e._id.$id;delete e._id;delete e._;return e})}});t=n.Router.extend({_page:null,routes:{"login(/)":"login","products(/)":"product","products/:key(/)":"product-view","cart(/)":"cart","checkout(/)":"checkout","help(/)":"help","profil(/)":"profil","error(/)(:number)":"error","logout(/)":"logout","":"home",":path":"error"},initialize:function(){f.views.page=new u;return f.collections.products=new r},load:function(e){return f.views.page.load(e)},reload:function(){n.history.stop();return n.history.start()},redirect:function(e){return f.controller.navigate(e,{trigger:!0})}});f.controller=new t;f.controller.on("route:home",function(){return f.views.page.load({template:"index",menu:"index"})});f.controller.on("route:login",function(){return f.views.page.load({template:"login",menu:"login"})});f.controller.on("route:product",function(){f.views.page.reset();f.views.page.loadCollection("products",f.collections.products);f.views.page.loadTemplate("product/list");return f.views.page.load({menu:"products"})});f.controller.on("route:product-view",function(e){alert(e);f.views.page.reset();f.views.page.loadModel("product",new f.models.product({id:e}));f.views.page.loadTemplate("product/view");return f.views.page.load({menu:"products"})});f.controller.on("route:cart",function(){return f.views.page.load({template:"cart/cart",menu:"cart"})});f.controller.on("route:checkout",function(){f.views.page.load({template:"checkout/checkout",menu:"cart"});return f.checkout.init()});f.controller.on("route:product-add",function(){if(f.models.customer.isLogin())return f.views.page.load({template:"product/add",menu:"product"})});f.controller.on("route:order",function(){if(f.models.customer.isLogin())return f.views.page.load({template:"order/index",data:{url:"order/list",type:"get"},menu:"order"})});f.controller.on("route:order-view",function(e){if(f.models.customer.isLogin())return f.views.page.load({template:"order/view",data:{url:"order/view",data:{id:e},type:"get"},menu:"order"})});f.controller.on("route:promotion",function(){if(f.models.customer.isLogin())return f.views.page.load({template:"promotion/index",data:{url:"coupon/list",type:"get"},menu:"promotion"})});f.controller.on("route:promotion-add",function(){if(f.models.customer.isLogin())return f.views.page.load({template:"promotion/add",menu:"promotion"})});f.controller.on("route:analytic",function(){if(f.models.customer.isLogin())return f.views.page.load({template:"analytic/index",menu:"analytic"})});f.controller.on("route:setting",function(){if(f.models.customer.isLogin())return f.views.page.load({template:"setting/index",menu:"setting"})});f.controller.on("route:home-redirect",function(){return f.controller.redirect("home")});f.controller.on("route:logout",function(){if(f.models.customer.isLogin())return f.models.customer.logout()});n.history.start({pushState:!0});e(function(){return e(".wrapper").on("click","a",function(t){var n;n=e(this).attr("href");if(n&&n.length>1&&n.substring(0,3)!=="tel"&&n.substring(0,4)!=="http"&&n!=="#nav"){f.controller.redirect(n);return t.preventDefault()}})})}).call(this);