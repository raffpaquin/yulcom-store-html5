// Generated by CoffeeScript 1.6.3
(function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E={}.hasOwnProperty,S=function(e,t){function r(){this.constructor=e}for(var n in t)E.call(t,n)&&(e[n]=t[n]);r.prototype=t.prototype;e.prototype=new r;e.__super__=t.prototype;return e};window.app={debug:!1,collections:{},models:{},views:{},config:{}};window.Yulcom={Collection:{},Model:{},View:{}};o=window.app;s=window.Yulcom;e=window.$;u=window._;t=window.Backbone;i=window.Modernizr;n=window.Handlebars;t.emulateHTTP=!0;u.extend(o,t.Events);o.init=function(){this.customer=new s.Model.Customer;this.models.cart=new s.Model.Cart;this.customer.init();this.collections.products=new s.Collection.Product;this.collections.address=new s.Collection.Address;this.collections.cc=new s.Collection.Cc;this.views.header=new s.View.Header;this.views.page=new s.View.Page;this.views.header.render();this.router=new s.Router;return this};o.get=function(e){return this.config[e]};o.error=function(t,n){t==null&&(t="Unknown Server Error");n==null&&(n="body");if(""!==t)return e(".alert",n).length>0?e(".alert",n).first().text(t).slideDown(200):alert(t);if(e(".alert",n).length>0)return e(".alert",n).slideUp(200)};o.load=function(t,n){t==null&&(t=!0);n==null&&(n="body");e(".btn",n).toggleClass("loading",t);if(t)return this.error("")};o.config=window.configs;s.View.Page=function(t){function n(){a=n.__super__.constructor.apply(this,arguments);return a}S(n,t);n.prototype.el=e("#content");n.prototype.ressources={template:null,collection:[],model:[]};n.prototype.queue={template:0,collection:0,model:0,callback:[]};n.prototype.data={};n.prototype.action={};n.prototype.reset=function(){this.data={};this.action={};this.ressources={template:null,collection:{},model:{}};return{queue:{template:0,collection:0,model:0,callback:[]}}};n.prototype.loadCollection=function(e,t){this.ressources.collection[e]=t;if(typeof t.is_loaded=="undefined"||t.is_loaded===!1){this.queue.collection++;return this.ressources.collection[e].fetch({success:function(){var n;n=o.views.page;n.data[e]=t.toJSON();n.queue.collection--;return n.render()}})}return this.data[e]=t.toJSON()};n.prototype.loadModel=function(e,t){this.ressources.model[e]=t;if(typeof t.is_loaded=="undefined"||t.is_loaded===!1){this.queue.model++;return this.ressources.model[e].fetch({success:function(){var n;n=o.views.page;n.data[e]=t.toJSON();n.queue.model--;return n.render()}})}return this.data[e]=t.toJSON()};n.prototype.loadTemplate=function(e){this.ressources.template=e;this.queue.template++;return o.template.loadTemplateHtml(e,function(e){var t;t=o.views.page;t.queue.template--;return t.render()})};n.prototype.callback=function(e){return this.queue.callback.push(e)};n.prototype.load=function(t){e("body").addClass("loading");if(t.menu){e("ul.menu li").removeClass("active");e("ul.menu li[data-href="+t.menu+"]").addClass("active")}return this.render()};n.prototype.render=function(){var t,n,r,i,s;if(this.queue.template===0&&this.queue.model===0&&this.queue.collection===0){console.log(this.data);this.$el.html(o.template.render(this.ressources.template,this.data));e("body").removeClass("loading");e("body").scrollTop(0);e("input[type=textbox]").first().focus();i=this.queue.callback;s=[];for(n=0,r=i.length;n<r;n++){t=i[n];s.push(t())}return s}};return n}(t.View);s.View.Header=function(t){function n(){f=n.__super__.constructor.apply(this,arguments);return f}S(n,t);n.prototype.el=e("header");n.prototype.template="page/header";n.prototype.initialize=function(){return o.customer.on("change:is_login",this.render)};n.prototype.render=function(){var t;t=this;return o.template.loadTemplateHtml(this.template,function(){return e("header").html(o.template.render(t.template))})};return n}(t.View);s.View.Checkout=function(t){function n(){p=n.__super__.constructor.apply(this,arguments);return p}S(n,t);n.prototype.current_page=null;n.prototype.order={"shipping-address":1,"billing-address":2,"payment-method":3,review:4};n.prototype.init=function(){var e;e=o.views.page.action;e.current_page=null;return e.goTo("shipping-address")};n.prototype.goTo=function(t){var n;if(t===this.current_page)return;if(this.order[t]==null)return;if(e(".checkout-panel li.step-"+t).length===0){setTimeout(function(){return o.checkout.goTo(t)},200);return}this.order[t]>this.order[this.current_page]?n=-1:n=1;e(".checkout-panel").animate({opacity:0,left:200*n+"px"},200,"swing",function(){e(".checkout-panel li").hide(0);e(".checkout-progress li").removeClass("active");e(".checkout-progress li.progress-"+t).addClass("active");e(".checkout-panel li.step-"+t).show(0);e(".checkout-panel").css({left:-200*n+"px"});return e(".checkout-panel").animate({opacity:1,left:0},200,"swing",function(){e(".checkout-panel li.step-"+t+" input").first().focus();if(t==="payment-method")return e("input.cc-num").payment("formatCardNumber")})});this.current_page=t;return!0};n.prototype.saveSection=function(t,n){n==null&&(n=!1);switch(t){case"shipping-address":o.load(!0);if(n===!1){n=o.api.stringToJson(e("form#form-shipping-address").serialize());return o.views.page.action.saveAddress(n,function(e,t){if("success"===t.status)return o.views.page.action.saveShippingAddress(t.data.address_id);o.load(!1);return o.error(t.message)})}return o.views.page.action.saveShippingAddress(n);case"billing-address":return this.goTo("payment-method");case"payment-method":return this.goTo("review");case"review":return alert("ORDER BITCHES!")}};n.prototype.saveAddress=function(e,t){var n;n=new s.Model.CustomerAddress;return n.save({address:e},{success:t,error:function(e){o.error("Unknown server error");return o.load(!1)},wait:!0})};n.prototype.saveShippingAddress=function(t,n){return o.api.post({url:"cart/shipping-address",data:{address_id:t},success:function(t){"success"===t.status?e("input[name=same-as-shipping]").is(":checked")?o.views.page.action.goTo("payment-method"):o.views.page.action.goTo("billing-address"):o.error(t.message);return o.load(!1)},error:function(e){return o.error()}})};n.prototype.toggleForm=function(t){var n,r;n=e("form",".step-"+t);r=e(".form-list",".step-"+t);return n.is(":visible")?n.fadeOut(100,function(){return r.fadeIn(100)}):r.fadeOut(100,function(){return n.fadeIn(100)})};return n}(s.View.Page);o.template={engines:[],requested:[],callback:{},render:function(t,n){n=e.extend({customer:o.customer.toJSON()},n);if(this.engines[t]){console.log(n);return this.engines[t](n)}return alert("Unknow Template Engine")},block:function(t,n){var r,i;i=this.render(t);r=e(n);r.html(i);return!0},loadTemplateHtml:function(t,r){if(!this.engines[t]){if(!this.requested[t]){this.requested[t]=!0;this.callback[t]=[r];return e.ajax({url:"/static/template/"+t+".mustache",context:{engines:this.engines,template_id:t,callback:this.callback},success:function(e){var t,i,s,o;this.engines[this.template_id]=n.compile(e);s=this.callback[this.template_id];o=[];for(t=0,i=s.length;t<i;t++){r=s[t];o.push(r())}return o},cache:!0,dataType:"html"})}return this.callback[t].push(r)}return r()}};n.registerHelper("round",function(e){return Math.round(e)});n.registerHelper("money",function(e){var t;e=parseFloat(e);if(e>=0)return"$"+e.toFixed(2);t=-1*e;return"$"+t.toFixed(2)+""});n.registerHelper("time",function(e){return window.moment(e*1e3).from()});e(function(){return e("body").on("click","[data-action]",function(t){var n,r,i,s;n=e(this);i=n.attr("data-action").split("|");r=i[0];s=i[1]!=null?i[1]:"body";if(!r||r==="")return!1;o.views.menu.nav.destroy();o.trigger(r,{scope:s,cta:this});t.preventDefault();return!1})});e(function(){o.on("all",o.analytics.trackEvent);return o.router.on("all",o.analytics.trackPageView)});o.analytics={trackEvent:function(e){},trackPageView:function(e){}};o.api={post:function(t){t.data&&typeof t.data=="string"&&(t.data=this.stringToJson(t.data));t.url=o.get("api")+t.url;t.dataType="json";o.customer.isLogin()&&(t.beforeSend=function(e){return e.setRequestHeader("Authorization","Basic "+window.btoa(o.customer.get("session_key")+":"+o.customer.get("session_password")))});e.ajax(t);return!0},stringToJson:function(e){return JSON.parse('{"'+decodeURIComponent(e).replace(/"/g,'\\"').replace(/&/g,'","').replace(/\=/g,'":"')+'"}')}};o.cookie={read:function(e){var t,n;e==null&&(e="");t=new RegExp("(?:^|; )"+encodeURIComponent(e)+"=([^;]*)");n=t.exec(document.cookie);return n!=null?n[1]:!1},write:function(e,t,n){var r,i;t==null&&(t="");n==null&&(n=360);i=new Date;i.setDate(i.getDate()+n);r=escape(t);n!=null&&(r=r+"; expires="+i.toUTCString());document.cookie=e+"="+r;return!0},"delete":function(e){return document.cookie=encodeURIComponent(e)+"=deleted; expires="+(new Date(0)).toUTCString()}};o.validation={email:function(e){return e.match(/^\w+@[a-zA-Z_]+?\.[a-zA-Z]{2,3}$/)!=null},name:function(e){return e.length>=2},password:function(e){return e.match(/^[a-zA-Z0-9!@#$%^&*]{6,16}$/)!=null},egals:function(e,t){return e===t}};s.Model.Base=function(e){function t(){d=t.__super__.constructor.apply(this,arguments);return d}S(t,e);t.is_loaded=!1;t.prototype.parse=function(e){return e.data?e.data:e};return t}(t.Model);r=t.Model.extend();o.models.product=t.Model.extend({url:function(){return o.get("api")+"catalog/product/"+this.id+"/details"},parse:function(e){return e.data?e.data:e}});s.Model.Cart=function(t){function n(){v=n.__super__.constructor.apply(this,arguments);return v}S(n,t);n.prototype.is_loaded=!1;n.prototype.url=function(){return o.get("api")+"cart/"};n.prototype.item={add:function(e){o.load(!0,".page-product");return o.api.post({url:"cart/product/add",data:{product_id:e},success:function(e){o.load(!1);if("success"===e.status){o.models.cart.set(e.data);o.models.cart.is_loaded=!0;return o.router.redirect("cart")}return o.error(e.message)}})},remove:function(t){o.load(!0,".main-cta");o.api.post({url:"cart/product/remove",data:{item_id:t},context:{item_id:t},success:function(n){return"success"===n.status?e(".item-"+t).fadeOut(300,function(){o.load(!1);o.models.cart.set(n.data);o.models.cart.is_loaded=!0;return o.router.reload("cart")}):o.error(n.message)}});e(".item-"+t).animate({opacity:.5});return 200}};n.prototype.coupon={add:function(t){o.load(!0,".cart-form-coupon");return o.api.post({url:"cart/coupon",data:{coupon:t},success:function(t){o.load(!1);if("success"===t.status){o.models.cart.set(t.data);o.models.cart.is_loaded=!0;return o.router.reload("cart")}o.error(t.message);return e("input").first().select()}})},remove:function(){return this.add("")}};return n}(s.Model.Base);s.Model.Customer=function(t){function n(){m=n.__super__.constructor.apply(this,arguments);return m}S(n,t);n.prototype.defaults={is_login:!1,session_key:!1,session_password:!1};n.prototype.init=function(){var t,n;t=o.cookie.read("ycsk");n=o.cookie.read("ycsd");if(!1===t||!1===n||"false"===t||"false"===n)return;this.login.saveSessionInfo(t,n,{});return e.ajaxSetup({headers:{Authorization:"Basic "+window.btoa(t+":"+n)}})};n.prototype.isLogin=function(){return this.get("is_login")};n.prototype.logout=function(){o.cookie.write("ycsk",!1);o.cookie.write("ycsd",!1);o.customer.set("session_key",!1);o.customer.set("session_password",!1);o.customer.set("customer_details",{});return o.customer.set("is_login",!1)};n.prototype.login={saveEmail:function(){var t;t=e(".login-step1 input[name=email]").val();o.load(!0,".login-box");if(o.validation.email(t))return e(".login-box .login-step1").fadeOut(200,function(){e(".login-box .login-step2").fadeIn(200);e(".login-step2 input[type=textbox]").first().focus();return o.customer.login.isLoading(!1)});o.error("Invalid Email Address",".login-box");e(".login-step1 input[type=textbox]").first().focus();return o.load(!1,".login-box")},savePassword:function(){var t,n,r,i,s;o.load(!0,".login-box");t=e(".login-step1 input[name=email]").val();n=e(".login-step2 input[name=firstname]").val();r=e(".login-step2 input[name=lastname]").val();i=e(".login-step2 input[name=password]").val();s=e(".login-step2 input[name=password2]").val();if(!o.validation.name(n)){o.error("Please enter a valid firstname",".login-box");e(".login-step2 input[name=firstname]").first().focus();o.load(!1);return}if(!o.validation.name(r)){o.error("Please enter a valid lastname",".login-box");e(".login-step2 input[name=lastname]").first().focus();o.load(!1);return}if(!o.validation.password(i)){o.error("Password must be between 6 and 16 characters",".login-box");e(".login-step2 input[name=password]").first().focus();o.load(!1);return}if(!o.validation.egals(i,s)){o.error("Both password must match",".login-box");e(".login-step2 input[name=password2]").first().focus();o.load(!1);return}return o.api.post({url:"customer/signup",data:{email:t,password:i,details:{firstname:n,lastname:r}},success:function(t){if(t.status==="success"){o.customer.login.saveSessionInfo(t.data.session_id,t.data.session_key,t.data.customer_details);return e(".login-box .login-step2").fadeOut(200,function(){e(".login-box .login-step4").fadeIn(200);return o.customer.login.isLoading(!1)})}o.error(t.message);return o.customer.login.isLoading(!1)},error:function(e){o.error("Unknow server error");return o.customer.login.isLoading(!1)}})},showLogin:function(){o.load(!0,".login-box");return e(".login-box .login-step1").fadeOut(200,function(){e(".login-box .login-step3").fadeIn(200);e(".login-step3 input[type=textbox]").first().focus();return o.customer.login.isLoading(!1)})},showAccountCreation:function(){o.load(!0,".login-box");return e(".login-box .login-step3").fadeOut(200,function(){e(".login-box .login-step1").fadeIn(200);e(".login-step1 input[type=textbox]").first().focus();return o.customer.login.isLoading(!1)})},saveSessionInfo:function(e,t,n){o.customer.set("session_key",e);o.customer.set("session_password",t);o.customer.set("customer_details",n);o.customer.set("is_login",!0);o.cookie.write("ycsk",e);return o.cookie.write("ycsd",t)},login:function(){return o.load(!1)}};return n}(t.Model);s.Model.CustomerAddress=function(e){function t(){g=t.__super__.constructor.apply(this,arguments);return g}S(t,e);t.prototype.url=function(){return o.get("api")+"customer/address"};return t}(s.Model.Base);s.Model.CustomerCC=function(e){function t(){y=t.__super__.constructor.apply(this,arguments);return y}S(t,e);return t}(s.Model.Base);s.Collection.Base=function(e){function t(){b=t.__super__.constructor.apply(this,arguments);return b}S(t,e);t.prototype.is_loaded=!1;t.prototype.parse=function(e){this.is_loaded=!0;return e.data.items?e.data.items:e.data};return t}(t.Collection);s.Collection.Product=function(e){function t(){w=t.__super__.constructor.apply(this,arguments);return w}S(t,e);t.prototype.model=o.models.product;t.prototype.url=o.get("api")+"catalog/product/list";t.prototype.parse=function(e){this.is_loaded=!0;return u.map(e.data.items,function(e){e.id=e._id.$id;delete e._id;delete e._;return e})};return t}(s.Collection.Base);s.Collection.Address=function(e){function t(){l=t.__super__.constructor.apply(this,arguments);return l}S(t,e);t.prototype.model=s.Model.CustomerAddress;t.prototype.url=function(){return o.get("api")+"customer/address/list"};return t}(s.Collection.Base);s.Collection.Cc=function(e){function t(){c=t.__super__.constructor.apply(this,arguments);return c}S(t,e);t.prototype.model=s.Model.CustomerCc;t.prototype.url=function(){return o.get("api")+"customer/cc/list"};return t}(s.Collection.Base);s.Router=function(e){function n(){h=n.__super__.constructor.apply(this,arguments);return h}S(n,e);n.prototype.routes={"login(/)":"login","products(/)":"product","products/:key(/)":"productView","cart(/)":"cart","checkout(/)":"checkout","help(/)":"help","profil(/)":"profil","error(/)(:number)":"error","logout(/)":"logout","":"home",":path":"error"};n.prototype.initialize=function(){return t.history.start({pushState:!0})};n.prototype.load=function(e){return o.views.page.load(e)};n.prototype.reload=function(){t.history.stop();return t.history.start()};n.prototype.redirect=function(e){return this.navigate(e,{trigger:!0})};n.prototype.home=function(){o.views.page.reset();o.views.page.loadTemplate("index");return o.views.page.load({menu:"index"})};n.prototype.login=function(){if(o.customer.isLogin())return this.redirect("/");o.views.page.reset();o.views.page.loadTemplate("login");return o.views.page.load({menu:"login"})};n.prototype.product=function(){o.views.page.reset();o.views.page.loadCollection("products",o.collections.products);o.views.page.loadTemplate("product/list");return o.views.page.load({menu:"products"})};n.prototype.productView=function(e){o.views.page.reset();o.views.page.loadModel("product",new o.models.product({id:e}));o.views.page.loadTemplate("product/view");return o.views.page.load({menu:"products"})};n.prototype.cart=function(){if(o.customer.isLogin()){o.views.page.reset();o.views.page.loadModel("cart",o.models.cart);o.views.page.loadTemplate("cart/cart");return o.views.page.load({menu:"cart"})}return this.redirect("/login")};n.prototype.checkout=function(){if(o.customer.isLogin()){o.views.page.reset();o.views.page.action=new s.View.Checkout;o.views.page.loadModel("cart",o.models.cart);o.views.page.loadCollection("address",o.collections.address);o.views.page.loadCollection("cc",o.collections.cc);o.views.page.loadTemplate("checkout/checkout");o.views.page.callback(o.views.page.action.init);return o.views.page.load({menu:"cart"})}return this.redirect("/login")};n.prototype.logout=function(){o.customer.logout();return location.href="/"};return n}(t.Router);e(function(){return e(".wrapper").on("click","a",function(t){var n;n=e(this).attr("href");if(n&&n.length>1&&n.substring(0,3)!=="tel"&&n.substring(0,4)!=="http"&&n!=="#nav"){o.router.redirect(n);return t.preventDefault()}})})}).call(this);